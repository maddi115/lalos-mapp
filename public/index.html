<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HUD Map ‚Äî 1-mile</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<!-- prevent favicon 404 spam -->
<link rel="icon" href="data:,">
<style>
:root{--bg:#fff}*{box-sizing:border-box}html,body,#gl{height:100%;width:100%;margin:0}
html,body{overflow:hidden;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
#gl{position:fixed;inset:0}
#ui{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:2147483647;width:560px;max-width:92vw;color:#e5e7eb;background:#000;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.55);padding:12px;display:flex;flex-direction:column;gap:10px}
#ui.compact{width:auto;max-width:none;padding:8px 10px;border-radius:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input,.btn,.tag{padding:10px 12px;border:0;border-radius:10px;background:#0a0a0a;color:#e5e7eb;outline:0}
.input{flex:1;min-width:200px}.input::placeholder{color:#9aa3ad}.input.tiny{padding:6px 8px;min-width:120px;font-size:12px}
.btn{cursor:pointer}.btn:hover{background:#111}.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn.link{background:transparent;padding:6px 8px;border-radius:8px;opacity:.8}.btn.link:hover{background:#0a0a0a;opacity:1}
.tag{font:600 12px/1 Inter;border-radius:999px}.help{font:600 12px/1.2 Inter;opacity:.9}.crosshair{cursor:crosshair!important}
.hide{display:none!important}
#note{position:fixed;top:10px;left:10px;background:#000;color:#fff;padding:6px 8px;border-radius:8px;font:600 12px/1 Inter;opacity:.9}
</style>
</head>
<body>
<div id="gl"></div><div id="note" class="hide">loading‚Ä¶</div>

<div id="ui" role="region" aria-label="Controls">
  <div class="row" id="topRow"><span id="locState" class="tag">Location: ‚Äî</span><span id="hint" class="help hide" aria-live="polite">Click ‚ÄúUse my location‚Äù to enable 1-mile ring</span></div>
  <div id="step1" class="row"><span class="tag">1/3</span><button id="doLoc" class="btn">üìç Use my location</button></div>
  <div id="step2" class="row hide"><span class="tag">2/3</span><span class="tag hide" id="placeTip">go on map and place inside radius</span><button id="placeHere" class="btn hide">Place here</button></div>
  <div id="step3" class="row hide"><span class="tag">3/3</span><button id="pick" class="btn">Upload image</button><button id="done" class="btn hide">‚úì Done</button></div>
  <div id="step3x" class="row hide"><span class="tag">Size: <span id="curPx">8px</span> / 349px</span><span class="tag" id="rate">rate: 1.35√ó</span></div>
  <div id="mini" class="row hide" aria-label="Compact"><span class="tag">Size: <span id="miniPx">8px</span> / 349px</span><button id="chg" class="btn link" aria-label="Change image">change image</button><input id="miniCmt" class="input tiny" type="text" maxlength="15" placeholder="comment‚Ä¶"/><button id="expand" class="btn" aria-label="Expand controls">‚ãØ</button></div>
  <input id="file" type="file" accept="image/*" style="display:none"/>
</div>

<script>
"use strict";
/* ===== helpers ===== */
const $=id=>document.getElementById(id), on=(e,t,f)=>e&&e.addEventListener(t,f), sh=(id,b)=>$(id)?.classList.toggle("hide",!b);
const note=t=>{const n=$("note");if(!n)return;n.textContent=t;n.classList.remove("hide")}, clearNote=()=>$("note")?.classList.add("hide");
const j=(u,o)=>fetch(u,o).then(async r=>{if(!r.ok){let body="";try{body=await r.text()}catch{};throw new Error(r.status+" "+r.statusText+(body?(" | "+body):""))}return r.json()});
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const getQS=(k)=> new URL(location.href).searchParams.get(k);

/* ===== consts ===== */
const MOBI=/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
const START=[-118.258683,34.017235], ZREF=16, MINPX=8, MAXPX=349, GOAL=229*60*1000, SPEED=1.35;
const RAD_M=1609.344, D2R=Math.PI/180, E111=111320, API="", LS_ID="lm_postId", LS_CMT="lm_comment", LS_DEV="lm_deviceId";
const MAX_CMT=15, SAVE_IVL=5000, SAVE_DPX=4;
const SID="s", LID="l", GIMG="g", GBOX="gb", RADS="rad", RADF="radf", RADL="radl";

/* ===== state ===== */
let map, anchor=null, userCenter=null, youMarker=null, step=1;
let mode="img", imgURL="", mediaReady=0, natW=0, natH=0, baseW=0, baseH=0, geoW=0, geoH=0;
let commentText="", domCmt=null, gifCanvas=null, gifCtx=null, gifRAF=0;
let tAct=0, tickTimer=0, lastPxSaved=+localStorage.getItem("lm_pxSaved")||0, lastPxAt=0;
let savedId=localStorage.getItem(LS_ID)||"", deviceId=localStorage.getItem(LS_DEV)||(crypto.getRandomValues(new Uint32Array(4)).join('-'));
localStorage.setItem(LS_DEV,deviceId);
const notFoundURLs=new Set(); const globalState=new Map(); let globalTimer=0; let NO_FEED=false;

/* ===== minis ===== */
const lsCmt=t=>{const v=(t||"").trim();v?localStorage.setItem(LS_CMT,v):localStorage.removeItem(LS_CMT)};
const mpp=(lng,lat)=>{const p=map.project([lng,lat]),x=map.unproject([p.x+1,p.y]),y=map.unproject([p.x,p.y+1]);return{x:Math.abs((x.lng-lng)*(E111*Math.cos(lat*D2R)||1e-9)),y:Math.abs((y.lat-lat)*E111)}};
const off=(lng,lat,dx,dy)=>({lng:lng+dx/(E111*Math.cos(lat*D2R)||1e-9),lat:lat+dy/E111});
const quad=(lng,lat,w,h)=>{const tl=off(lng,lat,-w/2,+h/2),tr=off(lng,lat,+w/2,+h/2),br=off(lng,lat,+w/2,-h/2),bl=off(lng,lat,-w/2,-h/2);return[[tl.lng,tl.lat],[tr.lng,tr.lat],[br.lng,br.lat],[bl.lng,bl.lat]]};
const fit=px=>{if(!natW||!natH){baseW=baseH=px;return}const a=natW/natH;a>=1?(baseW=px,baseH=Math.round(px/a)):(baseH=px,baseW=Math.round(px*a))};
const curPx=()=>Math.round(MINPX+(MAXPX-MINPX)*(1-Math.pow(1-Math.min(1,Math.max(0,tAct/GOAL)),3)));
const tFromPx=px=>{const y=clamp((px-MINPX)/(MAXPX-MINPX),0,1);return clamp((1-Math.cbrt(1-y))*GOAL,0,GOAL)};
const lockM=()=>{const c=anchor||map.getCenter(),r=mpp(c.lng,c.lat),s=Math.pow(2,map.getZoom()-ZREF);geoW=baseW*r.x*s;geoH=baseH*r.y*s};
const rm=(id,layer=1)=>{try{(layer?map.getLayer(id):map.getSource(id))&&(layer?map.removeLayer(id):map.removeSource(id))}catch{}};
const hasMedia=()=> (gifCanvas || imgURL);
const goodPost=p=>p&&Array.isArray(p.coordinates)&&((p.url||"").startsWith("/uploads/")||(p.url||"").startsWith("http")||(p.url||"").startsWith("data:"));

/* distance helpers */
const hav=(a,b,c,d)=>{const R=6371000,phi1=b*D2R,phi2=d*D2R,dphi=(d-b)*D2R,dl=(c-a)*D2R,x=Math.sin(dphi/2)**2+Math.cos(phi1)*Math.cos(phi2)*Math.sin(dl/2)**2;return 2*R*Math.asin(Math.sqrt(x))};
const inside=(lng,lat)=> userCenter? hav(lng,lat,userCenter.lng,userCenter.lat)<=RAD_M:false;
const near=(a,b)=>anchor? hav(a,b,anchor.lng,anchor.lat) <= 3 : false;

/* ring */
const circle=(lng,lat,r,n=96)=>({type:"Feature",geometry:{type:"Polygon",coordinates:[Array.from({length:n+1},(_,i)=>{const ang=i/n*2*Math.PI,p=off(lng,lat,Math.cos(ang)*r,Math.sin(ang)*r);return[p.lng,p.lat]})]}}); 
const drawRad=()=>{if(!userCenter)return;const d=circle(userCenter.lng,userCenter.lat,RAD_M);if(!map.getSource(RADS)){map.addSource(RADS,{type:"geojson",data:d});map.addLayer({id:RADF,type:"fill",source:RADS,paint:{"fill-color":"#2b2b2b","fill-opacity":.02}});map.addLayer({id:RADL,type:"line",source:RADS,paint:{"line-color":"#2b2b2b","line-width":2,"line-opacity":0.08}})}else map.getSource(RADS).setData(d)};

/* ===== clearing helpers for hard reset / empty DB ===== */
function removeLayerAndSource(idLayer, idSource){
  try{ if(map.getLayer(idLayer)) map.removeLayer(idLayer) }catch{}
  try{ if(map.getSource(idSource)) map.removeSource(idSource) }catch{}
}
function clearClientState(){
  removeLayerAndSource("l","s");
  try{ if(map.getLayer(GIMG+"l")) map.removeLayer(GIMG+"l") }catch{}
  try{ if(map.getSource(GIMG)) map.removeSource(GIMG) }catch{}
  try{ if(map.getLayer(GBOX+"l")) map.removeLayer(GBOX+"l") }catch{}
  try{ if(map.getLayer(GBOX+"f")) map.removeLayer(GBOX+"f") }catch{}
  try{ if(map.getSource(GBOX)) map.removeSource(GBOX) }catch{}
  try{ if(map.getLayer(RADL)) map.removeLayer(RADL) }catch{}
  try{ if(map.getLayer(RADF)) map.removeLayer(RADF) }catch{}
  try{ if(map.getSource(RADS)) map.removeSource(RADS) }catch{}

  if (globalState instanceof Map) {
    for (const [id,g] of Array.from(globalState.entries())) {
      try{ if(g?.layerId && map.getLayer(g.layerId)) map.removeLayer(g.layerId) }catch{}
      try{ if(g?.srcId && map.getSource(g.srcId)) map.removeSource(g.srcId) }catch{}
      try{ g?.marker?.remove?.() }catch{}
      globalState.delete(id);
    }
  }

  try{ domCmt?.remove?.(); domCmt=null }catch{}
  try{ youMarker?.remove?.(); youMarker=null }catch{}

  commentText=""; lsCmt("");
  imgURL=""; mediaReady=0; savedId=""; localStorage.removeItem(LS_ID);
  lastPxSaved=0; localStorage.removeItem("lm_pxSaved");
  anchor=null; userCenter=null;

  const loc=$("locState"); if(loc) loc.textContent="Location: ‚Äî";
  const hint=$("hint"); if(hint){ hint.textContent="Click ‚ÄúUse my location‚Äù to enable 1-mile ring"; hint.classList.add("hide") }
  ["mini","step2","step3","step3x","placeHere","placeTip"].forEach(id=>$(id)?.classList.add("hide"));
  $("step1")?.classList.remove("hide");
}

/* map init */
const FALLBACK_STYLE={version:8,name:"OSM Raster",sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"¬© OpenStreetMap contributors"}},layers:[{id:"osm",type:"raster",source:"osm"}]};
async function initMap(){
  if(window.maplibregl&&typeof maplibregl.supported==="function"&&!maplibregl.supported()) return note("WebGL disabled.");
  note("loading map‚Ä¶");
  let style=null; try{const r=await fetch("https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",{mode:"cors"}); if(r.ok) style=await r.json()}catch{}
  map=new maplibregl.Map({container:"gl",style:style||FALLBACK_STYLE,center:START,zoom:11,dragRotate:false,pitchWithRotate:false,maxPitch:0,renderWorldCopies:false,antialias:false,trackResize:true,fadeDuration:0});
  map.addControl(new maplibregl.NavigationControl({showCompass:false}),"bottom-right");
  map.on("error",e=>{console.error(e);note("map error (see console)")});
  map.on("load",async()=>{
    map.resize(); clearNote(); wire(); init(); tick();
    await restore();
    if(!NO_FEED) enableFeed();
  });
  map.on("move",()=>{if(anchor){refreshCmt();refreshYou()}})
}

/* you label */
const youPos=()=>anchor?[anchor.lng,anchor.lat+((geoH/2)+10)/E111]:null;
const showYou=()=>{if(!anchor)return;const p=youPos();if(!p)return;if(!youMarker){const el=document.createElement("div");el.textContent="you";el.style.cssText="font:600 11px/1 Inter,system-ui;color:#111;background:#fff;padding:2px 6px;border-radius:999px;border:1px solid #ddd;box-shadow:0 1px 2px rgba(0,0,0,.06);pointer-events:none;";youMarker=new maplibregl.Marker({element:el,anchor:"bottom"}).setLngLat(p).addTo(map)}else youMarker.setLngLat(p)};
const refreshYou=()=>{if(youMarker&&anchor){const p=youPos();p&&youMarker.setLngLat(p)}},hideYou=()=>{youMarker?.remove();youMarker=null},youAuto=()=>{(commentText.trim()?hideYou:showYou)()};

/* place preview */
let cleanup=()=>{};
const ghostAt=(lng,lat)=>{if(!userCenter){$("hint")&&($("hint").textContent="Click ‚ÄúUse my location‚Äù first");sh("hint",true);return ghost(1)}if(!inside(lng,lat)){ghost(1);if(step===2){$("hint")&&($("hint").textContent="place inside 1-mile radius");sh("hint",true)};return}
  const px=curPx();fit(px);const r=mpp(lng,lat),s=Math.pow(2,map.getZoom()-ZREF),w=baseW*r.x*s,h=baseH*r.y*s,c=quad(lng,lat,w,h);
  const poly={type:"Feature",geometry:{type:"Polygon",coordinates:[[...c,c[0]]]}}; 
  if(!map.getSource(GBOX)){map.addSource(GBOX,{type:"geojson",data:poly});map.addLayer({id:GBOX+"f",type:"fill",source:GBOX,paint:{"fill-color":"#1e90ff","fill-opacity":.08}});map.addLayer({id:GBOX+"l",type:"line",source:GBOX,paint:{"line-color":"#1e90ff","line-width":2}})}else map.getSource(GBOX).setData(poly);
  if(imgURL){if(!map.getSource(GIMG)){map.addSource(GIMG,{type:"image",url:imgURL,coordinates:c});map.addLayer({id:GIMG+"l",type:"raster",source:GIMG,paint:{"raster-opacity":.35,"raster-fade-duration":0}})}else map.getSource(GIMG)?.setCoordinates?.(c)}};
const ghost=b=>{if(!b)return;rm(GIMG+"l",1);rm(GIMG,0);rm(GBOX+"l",1);rm(GBOX+"f",1);rm(GBOX,0)};
const startPlace=()=>{try{cleanup()}catch{};$("hint")&&($("hint").textContent=MOBI?"Pan map, then Place here":"go on map and place inside radius");sh("hint",true);
  if(!MOBI){
    const mv=e=>ghostAt(e.lngLat.lng,e.lngLat.lat);
    const ck=e=>{const{lng,lat}=e.lngLat;if(!inside(lng,lat))return($("hint")&&($("hint").textContent="place inside 1-mile radius"),sh("hint",true));
      stop();anchor={lng,lat};fit(curPx());lockM();if(hasMedia())apply();if(mediaReady)updStamp();updCmt();youAuto();stepShow(3)};
    const key=ev=>{if(ev.key==="Escape")stop()};
    map.getCanvas().classList.add("crosshair");map.on("mousemove",mv);map.once("click",ck);document.addEventListener("keydown",key);
    cleanup=()=>{map.getCanvas().classList.remove("crosshair");try{map.off("mousemove",mv)}catch{};try{document.removeEventListener("keydown",key)}catch{};ghost(1);sh("hint",false)}
  }else{
    const follow=()=>{const c=map.getCenter();ghostAt(c.lng,c.lat)};map.on("move",follow);follow();sh("placeHere",true);
    const placeNow=()=>{const c=map.getCenter();if(!inside(c.lng,c.lat))return alert("Place inside your 1-mile radius.");anchor={lng:c.lng,lat:c.lat};stop();fit(curPx());lockM();if(hasMedia())apply();if(mediaReady)updStamp();updCmt();youAuto();stepShow(3)};
    on($("placeHere"),"click",placeNow);
    cleanup=()=>{try{map.off("move",follow)}catch{};sh("placeHere",false);ghost(1);sh("hint",false)}
  } function stop(){try{cleanup()}catch{}}
};

/* media */
const clearGIF=()=>{cancelAnimationFrame(gifRAF);gifRAF=0;gifCanvas=gifCtx=null};
const clearMedia=()=>{clearGIF();rm(LID,1);rm(SID,0);rm(GIMG+"l",1);rm(GIMG,0);mediaReady=0;sh("step3x",false)};
const apply=()=>{clearMedia();purgeGlobalsNearMine();if(!anchor)return;const c=quad(anchor.lng,anchor.lat,geoW,geoH);
  if(gifCanvas){map.addSource(SID,{type:"canvas",canvas:gifCanvas,coordinates:c,animate:true});map.addLayer({id:LID,type:"raster",source:SID,paint:{"raster-opacity":1,"raster-fade-duration":0}});mediaReady=1;updCmt();sh("step3x",true);compactify();youAuto();saveOnce();return}
  map.addSource(SID,{type:"image",url:imgURL,coordinates:c});map.addLayer({id:LID,type:"raster",source:SID,paint:{"raster-opacity":1,"raster-fade-duration":0}});mediaReady=1;updCmt();sh("step3x",true);compactify();youAuto();saveOnce()
};
const updStamp=()=>{const s=map.getSource(SID);s&&anchor&&s.setCoordinates?.(quad(anchor.lng,anchor.lat,geoW,geoH))};

/* comments */
const stampPx=()=>{if(!anchor)return{h:0};const tl=off(anchor.lng,anchor.lat,-geoW/2,+geoH/2),br=off(anchor.lng,anchor.lat,+geoW/2,-geoH/2);
  const p1=map.project([tl.lng,tl.lat]),p2=map.project([br.lng,br.lat]);return{h:Math.abs(p2.y-p1.y)}};
const refreshCmt=()=>{if(!domCmt||!anchor)return;const latUp=anchor.lat+((geoH/2)+6)/E111;domCmt.setLngLat([anchor.lng,latUp]);const{h}=stampPx();const px=Math.max(13,Math.min(64,h*0.12));domCmt.getElement().style.fontSize=px.toFixed(2)+"px"};
const updCmt=()=>{commentText=(commentText||"").slice(0,MAX_CMT);const t=commentText.trim();
  if(!t||!anchor){domCmt?.remove();domCmt=null;lsCmt("");youAuto();return}
  hideYou();
  if(!domCmt){const el=document.createElement("div");el.style.cssText=["font:700 12px/1.25 Inter, system-ui","color:#111","background:rgba(255,255,255,.98)","padding:4px 8px","border-radius:10px","border:1px solid rgba(0,0,0,.12)","box-shadow:0 2px 8px rgba(0,0,0,.25)","pointer-events:none"].join(";");el.textContent=t;domCmt=new maplibregl.Marker({element:el,anchor:"bottom"}).setLngLat([anchor.lng,anchor.lat]).addTo(map)}else domCmt.getElement().textContent=t;
  refreshCmt();lsCmt(t)
};

/* save/restore */
const capCmt=v=>((v||"").slice(0,MAX_CMT).trim()||null);
async function saveOrUpdate(fields){
  try{
    const cmt = fields && fields.comment !== undefined ? capCmt(fields.comment) : capCmt(commentText);
    if(!savedId){
      if(!anchor||!hasMedia())return;
      const body={lng:anchor.lng,lat:anchor.lat,mediaType:gifCanvas?'gif':'img',url:(imgURL||null),
        comment:cmt,natSize:(natW&&natH)?{w:natW,h:natH}:null,pxAtPlace:(typeof fields?.pxAtPlace==="number")?fields.pxAtPlace:curPx(),
        userCenter:userCenter||null,deviceId};
      const r=await j(`${API}/api/posts`,{method:"POST",headers:{"Content-Type":"application/json","X-Device-Id":deviceId},body:JSON.stringify(body)});
      if(r&&r.id){savedId=r.id;localStorage.setItem(LS_ID,savedId); purgeGlobalsNearMine(); }
    }else{
      const patch={...fields}; if(patch.comment!==undefined) patch.comment = capCmt(patch.comment);
      const resp=await fetch(`${API}/api/posts/${savedId}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-Device-Id":deviceId},body:JSON.stringify(patch)});
      if(!resp.ok && resp.status===404){ savedId=""; localStorage.removeItem(LS_ID); }
    }
  }catch(e){ console.error("save/update failed",e) }
}
async function maybeSaveSize(px){
  if(!anchor||!hasMedia())return; const now=Date.now();
  if(!savedId){ await saveOrUpdate({pxAtPlace:Math.round(px)}); lastPxSaved=Math.round(px); lastPxAt=now; localStorage.setItem("lm_pxSaved",String(lastPxSaved)); return }
  if(Math.abs(px-(lastPxSaved||0))>=SAVE_DPX && (now-lastPxAt)>=SAVE_IVL){
    await saveOrUpdate({pxAtPlace:Math.round(px)}); lastPxSaved=Math.round(px); lastPxAt=now; localStorage.setItem("lm_pxSaved",String(lastPxSaved));
  }
}
async function saveOnce(){ if(savedId||!anchor||!hasMedia())return; await saveOrUpdate({pxAtPlace:curPx(),comment:capCmt(commentText)}) }
async function headOK(u){
  try{
    const r=await fetch(u,{method:'HEAD',cache:'no-store'});
    if(r.ok) return true;
    const g=await fetch(u,{method:'GET',cache:'no-store',headers:{'Range':'bytes=0-0'}});
    return g.ok;
  }catch{ return false }
}
function removeGlobalId(id){
  const g=globalState.get(id); if(!g) return;
  try{ map.getLayer(g.layerId)&&map.removeLayer(g.layerId) }catch{}
  try{ map.getSource(g.srcId)&&map.removeSource(g.srcId) }catch{}
  try{ g.marker && g.marker.remove && g.marker.remove() }catch{}
  globalState.delete(id);
}
function purgeGlobalsNearMine(){
  if(!anchor) return;
  for(const [id,g] of Array.from(globalState.entries())){
    if(!g || !g.coords) continue;
    const [lng,lat]=g.coords;
    if(near(lng,lat) || (savedId && id===savedId)){ removeGlobalId(id) }
  }
}
async function restore(){
  if (getQS('reset') === '1') {
    try { clearClientState() } catch(e) { console.warn('reset clear failed', e) }
    NO_FEED = true;
    stepShow(1);
    return;
  }

  let p=null, id=localStorage.getItem(LS_ID)||"";
  try{
    if(id){ try{ p=await j(`${API}/api/posts/${id}`) }catch{} }
    if(!p){ const did=localStorage.getItem(LS_DEV); if(did){ try{ p=await j(`${API}/api/posts/latest?deviceId=${encodeURIComponent(did)}`) }catch{} } }
    if(!p){ try{ p=await j(`${API}/api/posts/latest`) }catch{} }
    if(!goodPost(p)){ p=null }
  }catch(e){ console.error("restore",e) }

  if(!p){
    clearClientState();
    stepShow(1);
    return;
  }

  savedId=p.id; localStorage.setItem(LS_ID,savedId);
  anchor={lng:p.coordinates[0],lat:p.coordinates[1]}; userCenter=p.userCenter||null; if(userCenter) drawRad();

  mode=(p.mediaType==='gif')?'gif':'img';
  imgURL=p.url||"";
  if(p.natSize&&p.natSize.w&&p.natSize.h){ natW=p.natSize.w; natH=p.natSize.h }

  const px=p.pxAtPlace||MINPX; tAct=tFromPx(px);
  lastPxSaved=Math.round(px); localStorage.setItem("lm_pxSaved",String(lastPxSaved));
  fit(px); lockM(); apply();

  commentText=(p.comment ?? ""); commentText=commentText.slice(0,MAX_CMT);
  lsCmt(commentText); updCmt(); youAuto();

  map.easeTo({center:[anchor.lng,anchor.lat],zoom:14,duration:400}); stepShow(3); sh("step3x",true); compactify();
}

/* compact + tick */
const setCompact=b=>{ $("ui")?.classList.toggle("compact",!!b); sh("mini",!!b); ["topRow","step1","step2","step3","step3x","hint"].forEach(id=>sh(id,!b&&(id!=="step3x"||step===3))); if(!b) stepShow(step) };
const finalizeUI=()=>["topRow","step1","step2","step3","step3x","hint","expand"].forEach(id=>$(id)?.parentNode?.removeChild($(id)));
const compactify=()=>{sh("done",true); setCompact(true); finalizeUI()};
const grow=()=>{const px=curPx(); $("curPx")&&($("curPx").textContent=px+"px"); $("miniPx")&&($("miniPx").textContent=px+"px"); if(!anchor)return; fit(px); lockM(); mediaReady&&updStamp(); refreshCmt(); refreshYou(); maybeSaveSize(px)};
const tick=()=>{if(tickTimer)return; let last=performance.now(); tickTimer=setInterval(()=>{const n=performance.now(); tAct=Math.min(GOAL,tAct+(n-last)*SPEED); last=n; grow()},1000)};

/* steps & geo */
const setLoc=t=>{const e=$("locState");e&&(e.textContent=t)}
const init=()=>{stepShow(1);$("doLoc")&&($("doLoc").textContent="üìç Use my location");$("rate")&&($("rate").textContent="rate: 1.35√ó");setLoc("allow location to show your 1-mile radius")};
const setHint=()=>{ const h=$("hint"); if(!h) return; if(step===2 && !MOBI){ h.textContent="go on map and place inside radius"; h.classList.remove("hide") } else { h.classList.add("hide") } };
function stepShow(n){
  step=n;
  ["step1","step2","step3","step3x","placeHere","placeTip"].forEach(id=>{
    const el=$(id); if(!el) return;
    if(id==="step1") el.classList.toggle("hide", !(n===1));
    if(id==="step2"||id==="placeTip"||id==="placeHere") el.classList.toggle("hide", !(n===2));
    if(id==="step3"||id==="step3x") el.classList.toggle("hide", !(n===3));
  });
  setHint();
}
$("doLoc") && ($("doLoc").onclick=()=>geoOnce());
navigator.permissions?.query?.({name:"geolocation"}).then(s=>{if(s.state==="denied"){const h=$("hint");if(h){h.textContent="Location blocked. Allow it in site settings.";sh("hint",true)}}}).catch(()=>{});
function geoOnce(){
  setLoc("Location: requesting‚Ä¶"); if(!("geolocation"in navigator))return setLoc("Location: unsupported"),alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(p=>{
    const lng=p.coords.longitude, lat=p.coords.latitude;
    userCenter={lng,lat}; drawRad(); setLoc("location confirmed"); map.easeTo({center:[lng,lat],zoom:14,duration:600}); stepShow(2); startPlace();
  }, _=>{
    setLoc("Location: denied/unavailable");
    if(!window.isSecureContext&&location.hostname!=="localhost")alert("Use HTTPS or http://localhost"); else alert("Couldn‚Äôt get location. Check site permissions.");
  }, {enableHighAccuracy:true,timeout:30000,maximumAge:0});
}

/* loaders (images only; GIF supported) */
const startGIF=()=>{if(!gifCanvas)return;const d=()=>{if(!gifCanvas)return;gifCtx.clearRect(0,0,gifCanvas.width,gifCanvas.height);gifCtx.drawImage(gifCanvas._img,0,0,gifCanvas.width,gifCanvas.height);map.triggerRepaint();gifRAF=requestAnimationFrame(d)};d()};
const setupGIF=src=>{imgURL=src;const im=new Image();im.crossOrigin="anonymous";im.onload=()=>{natW=im.naturalWidth||256;natH=im.naturalHeight||256;const cap=1024,s=Math.min(1,cap/Math.max(natW,natH));gifCanvas=document.createElement("canvas");gifCanvas.width=Math.max(1,Math.round(natW*s));gifCanvas.height=Math.max(1,Math.round(natH*s));gifCtx=gifCanvas.getContext("2d");gifCanvas._img=im;if(!anchor){$("hint")&&($("hint").textContent="Place first");sh("hint",true);return}startGIF();apply()};im.onerror=()=>alert("Couldn't load GIF.");im.src=src};
const uploadFile=async(f)=>{const form=new FormData();form.append('file',f,f.name||'upload');const r=await fetch(`${API}/api/upload`,{method:'POST',body:form});if(!r.ok)throw new Error('upload failed');return r.json()};
const loadFile=async(f)=>{if(!anchor){$("hint")&&($("hint").textContent="Place first");sh("hint",true);return}try{
  const {url,mime}=await uploadFile(f);
  if(mime==='image/gif'){mode='gif';setupGIF(url);return}
  mode='img';imgURL=url;const im=new Image();im.crossOrigin="anonymous";im.onload=()=>{natW=im.naturalWidth||256;natH=im.naturalHeight||256;apply()};im.onerror=()=>alert("Couldn't load image.");im.src=url
}catch(e){console.error(e);alert('Upload failed. Try again.')}};

/* ===== global feed (images only) ===== */
const id4=p=>`g-${p.id}`; 
function upsertGlobalLabel(p){
  const g=globalState.get(p.id)||{};
  const t=(p.comment||"").slice(0,MAX_CMT).trim();
  if(!t){ if(g.marker){ g.marker.remove(); g.marker=null } globalState.set(p.id,{...g,marker:null}); return }
  const el = g.marker?.getElement?.() || (()=>{const e=document.createElement("div");e.style.cssText="font:700 12px/1.25 Inter;color:#111;background:rgba(255,255,255,.98);padding:4px 8px;border-radius:10px;border:1px solid rgba(0,0,0,.12);box-shadow:0 2px 8px rgba(0,0,0,.25);pointer-events:none;";return e})();
  el.textContent=t;
  const mk = g.marker || new maplibregl.Marker({element:el,anchor:"bottom"}).setLngLat([p.coordinates[0],p.coordinates[1]]).addTo(map);
  mk.setLngLat([p.coordinates[0],p.coordinates[1]]);
  globalState.set(p.id,{...g,marker:mk});
}
async function upsertGlobalImage(p){
  if(!Array.isArray(p.coordinates)||p.coordinates.length<2) return;
  if( (savedId && p.id===savedId) || near(p.coordinates[0],p.coordinates[1]) ) return;
  if(p.url && notFoundURLs.has(p.url)) return;
  if(p.url && p.url.startsWith('/uploads/')){
    const ok = await headOK(p.url);
    if(!ok){ notFoundURLs.add(p.url); return }
  }
  const [lng,lat]=p.coordinates, lid=id4(p), sid=lid+"-s";
  const px=Math.max(MINPX,Math.min(MAXPX, +p.pxAtPlace||160)), r=mpp(lng,lat), s=Math.pow(2,map.getZoom()-ZREF);
  const w=px*r.x*s, h=px*r.y*s, coords=quad(lng,lat,w,h);

  if(!map.getSource(sid)){
    map.addSource(sid,{type:'image',url:p.url,coordinates:coords});
    map.addLayer({id:lid,type:'raster',source:sid,paint:{'raster-opacity':0.98,'raster-fade-duration':0}});
  }else{
    map.getSource(sid).setCoordinates(coords);
  }
  const prev=globalState.get(p.id)||{};
  globalState.set(p.id,{layerId:lid,srcId:sid,coords:[lng,lat],px,marker:prev.marker,lastSeen:Date.now()});
  upsertGlobalLabel(p);
}
async function fetchGlobalInView(){
  try{
    const c=map.getCenter(); const q=`?lng=${c.lng}&lat=${c.lat}&radiusMeters=5000&limit=80`;
    let rows = await j(`${API}/api/posts/near${q}`);
    rows.sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0));
    for(const p of rows){ if(!p.url) continue; await upsertGlobalImage(p) }
  }catch(e){ /* ignore */ }
}
function enableFeed(){ if(globalTimer) clearInterval(globalTimer); fetchGlobalInView(); globalTimer=setInterval(fetchGlobalInView,2000) }

/* wiring */
function wire(){
  const deb=(f,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),ms)}};
  on($("pick"),"click",()=>$("file")?.click());
  on($("file"),"change",e=>{const f=e.target.files?.[0];f&&loadFile(f);e.target.value=""});

  const saveCmt=deb(async()=>{ lsCmt(commentText); await saveOrUpdate({comment:capCmt(commentText)}) },400);
  on($("miniCmt"),"input",async()=>{ commentText=$("miniCmt").value.slice(0,MAX_CMT); updCmt(); await saveCmt() });
  on($("chg"),"click",()=>$("file")?.click());
  on($("expand"),"click",()=>setCompact(false));
  on($("done"),"click",()=>{ setCompact(true); finalizeUI() });
  const flush=async()=>{ try{
      lsCmt(commentText); if(!savedId) return;
      const r=await fetch(`${API}/api/posts/${savedId}`,{method:"PATCH",keepalive:true,headers:{'Content-Type':'application/json','X-Device-Id':deviceId},body:JSON.stringify({comment:capCmt(commentText),pxAtPlace:curPx()})});
      if(!r.ok && r.status===404){ savedId=""; localStorage.removeItem(LS_ID) } else { localStorage.setItem("lm_pxSaved",String(curPx())) }
    }catch{} };
  document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==='hidden') flush() });
  window.addEventListener("pagehide",flush);
}

/* go */
initMap();
</script>
</body>
</html>
