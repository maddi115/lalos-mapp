<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HUD Map ‚Äî 1-mile radius</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<style>
:root{--bg:#fff}*{box-sizing:border-box}html,body,#gl{height:100%;width:100%;margin:0}
html,body{overflow:hidden;background:var(--bg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
#gl{position:fixed;inset:0}
#ui{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:2147483647;width:560px;max-width:90vw;color:#e5e7eb;background:#000;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.55);padding:12px;display:flex;flex-direction:column;gap:10px}
#ui.compact{width:auto;max-width:none;padding:8px 10px;border-radius:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input,.btn,.tag{padding:10px 12px;border:0;border-radius:10px;background:#0a0a0a;color:#e5e7eb;outline:0}
.input{flex:1;min-width:200px}.input::placeholder{color:#9aa3ad}.input.tiny{padding:6px 8px;min-width:120px;font-size:12px}
.btn{cursor:pointer}.btn:hover{background:#111}.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn.link{background:transparent;padding:6px 8px;border-radius:8px;opacity:.8}.btn.link:hover{background:#0a0a0a;opacity:1}
.tag{font:600 12px/1 Inter;border-radius:999px}.help{font:600 12px/1.2 Inter;opacity:.9}.crosshair{cursor:crosshair!important}
#ytBox{position:absolute;z-index:2147483601;border:0;overflow:hidden}#ytBox iframe{width:100%;height:100%;border:0;display:block}
.hide{display:none!important}#note{position:fixed;top:10px;left:10px;background:#000;color:#fff;padding:6px 8px;border-radius:8px;font:600 12px/1 Inter;opacity:.9}
</style></head><body>
<div id="gl"></div><div id="note" class="hide">loading‚Ä¶</div>
<div id="ui" role="region" aria-label="Controls">
  <div class="row" id="topRow"><span id="locState" class="tag">Location: ‚Äî</span><span id="hint" class="help hide" aria-live="polite">Click ‚ÄúUse my location‚Äù to enable 1-mile ring</span></div>
  <div id="step1" class="row"><span class="tag">1/3</span><button id="doStep1" class="btn">üìç Use my location</button></div>
  <div id="step2" class="row hide"><span class="tag">2/3</span><span class="tag hide" id="placeTip">go on map and place inside radius</span><button id="placeHere" class="btn hide">Place here</button></div>
  <div id="step3" class="row hide"><span class="tag">3/3</span><button id="picUpload" class="btn">Upload image/video</button><input id="picInput" class="input" type="url" placeholder="Paste media URL (image/GIF/video/YouTube)"/><button id="doneBtn" class="btn hide">‚úì Done</button></div>
  <div id="step3x" class="row hide"><span class="tag">Size: <span id="curSize">8px</span> / 349px</span><span class="tag" id="rateTag">rate: 1.35√ó</span></div>
  <div id="compact" class="row hide" aria-label="Compact Controls"><span class="tag">Size: <span id="miniCur">8px</span> / 349px</span><button id="changeImg" class="btn link" aria-label="Change image">change image</button><input id="miniCmt" class="input tiny" type="text" maxlength="15" placeholder="comment‚Ä¶"/><button id="expandUI" class="btn" aria-label="Expand controls">‚ãØ</button></div>
  <input id="picFile" type="file" accept="image/*,video/*" style="display:none"/>
</div>

<script>
"use strict";
/* helpers */
const $=id=>document.getElementById(id),on=(el,ev,fn)=>el&&el.addEventListener(ev,fn),sh=(id,b)=>{const e=$(id);e&&e.classList.toggle("hide",!b)};
const note=t=>{const n=$("note");if(!n)return;n.textContent=t;n.classList.remove("hide")},clearNote=()=>$("note")?.classList.add("hide");
const fetchJSON=(u,o)=>fetch(u,o).then(r=>{if(!r.ok)throw new Error(r.status+" "+r.statusText);return r.json()});
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
/* consts */
const MOBI=/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
const START=[-118.258683,34.017235],ZREF=16,MINPX=8,MAXPX=349,GOAL=229*60*1000,SPEED=1.35;
const SID="stamp",LID="stampL",GIMG="gImg",GIMGL="gImgL",GBOX="gBox",GBOXF="gBoxF",GBOXL="gBoxL";
const RAD_M=1609.344,RADSRC="postRadius",RADF="postRadiusFill",RADL="postRadiusOutline";
const D2R=Math.PI/180,E111=111320,API="",SAVE_INTERVAL_MS=5000,SAVE_DELTA_PX=4,MAX_CMT=15;
/* state */
let map,imgURL="",natW=0,natH=0,baseW=0,baseH=0,geoW=0,geoH=0,anchor=null,tAct=0,timer=0;
let ytBox=null,ytID="",mediaReady=0,mode="img",gifCanvas=null,gifCtx=null,gifRAF=0;
let commentText="",domCmt=null,blobURL="",userCenter=null,compact=false,youMarker=null,step=1;
const LS_ID="lm_postId",LS_COMMENT="lm_comment",LS_DEVICE="lm_deviceId";
let savedId=localStorage.getItem(LS_ID)||"";
let deviceId=localStorage.getItem(LS_DEVICE)||(crypto.getRandomValues(new Uint32Array(4)).join('-'));localStorage.setItem(LS_DEVICE,deviceId);
let lastPxSaved=Number(localStorage.getItem("lm_pxSaved")||"0"),lastPxSavedAt=0;
/* small utils */
const setLSComment=(t)=>{const v=(t||"").trim(); if(v) localStorage.setItem(LS_COMMENT,v); else localStorage.removeItem(LS_COMMENT);};
const mpp=(lng,lat)=>{const p=map.project([lng,lat]),x=map.unproject([p.x+1,p.y]),y=map.unproject([p.x,p.y+1]);return{x:Math.abs((x.lng-lng)*(E111*Math.cos(lat*D2R)||1e-9)),y:Math.abs((y.lat-lat)*E111)}};
const off=(lng,lat,dx,dy)=>({lng:lng+dx/(E111*Math.cos(lat*D2R)||1e-9),lat:lat+dy/E111});
const quad=(lng,lat,w,h)=>{const tl=off(lng,lat,-w/2,+h/2),tr=off(lng,lat,+w/2,+h/2),br=off(lng,lat,+w/2,-h/2),bl=off(lng,lat,-w/2,-h/2);return[[tl.lng,tl.lat],[tr.lng,tr.lat],[br.lng,br.lat],[bl.lng,bl.lat]]};
const fit=px=>{if(!natW||!natH){baseW=baseH=px;return}const a=natW/natH;a>=1?(baseW=px,baseH=Math.round(px/a)):(baseH=px,baseW=Math.round(px*a))};
const curPx=()=>Math.round(MINPX+(MAXPX-MINPX)*(1-Math.pow(1-Math.min(1,Math.max(0,tAct/GOAL)),3)));
const tFromPx=px=>{const y=clamp((px-MINPX)/(MAXPX-MINPX),0,1);return clamp((1-Math.cbrt(1-y))*GOAL,0,GOAL)};
const lockMeters=()=>{const c=anchor||map.getCenter(),r=mpp(c.lng,c.lat),s=Math.pow(2,map.getZoom()-ZREF);geoW=baseW*r.x*s;geoH=baseH*r.y*s};
const rm=(id,isLayer=1)=>{try{(isLayer?map.getLayer(id):map.getSource(id))&&(isLayer?map.removeLayer(id):map.removeSource(id))}catch{}};
const detect=u=>{const m=u.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=)([\w-]{11})/i);if(m)return{t:"yt",id:m[1]};const L=u.toLowerCase();if(/\.(mp4|webm|ogv)(\?|#|$)/.test(L)||L.startsWith("blob:"))return{t:"vid",url:u};if(/\.(gif)(\?|#|$)/.test(L)||/^data:image\/gif/.test(L))return{t:"gif",url:u};return{t:"img",url:u}};
const safeURL=u=>{try{if(u.startsWith("data:"))return true;if(u.startsWith("blob:"))return false;if(u.startsWith("/"))return true;const p=new URL(u,location.origin).protocol;return p==="http:"||p==="https:"}catch{return false}};
const setBlob=u=>{if(blobURL)URL.revokeObjectURL(blobURL);return blobURL=u};
const hasMedia=()=> (mode==="yt"&&ytID)||(mode==="gif"&&gifCanvas)||imgURL;
const isValidMedia=p=>{if(!p)return false;if(p.mediaType==="yt")return !!p.ytId;const u=p.url||"";if(!u||u.startsWith("blob:"))return false;return u.startsWith("/uploads/")||u.startsWith("http")||u.startsWith("data:")};
/* ring */
const hav=(a,b,c,d)=>{const R=6371000,phi1=b*D2R,phi2=d*D2R,dphi=(d-b)*D2R,dl=(c-a)*D2R,x=Math.sin(dphi/2)**2+Math.cos(phi1)*Math.cos(phi2)*Math.sin(dl/2)**2;return 2*R*Math.asin(Math.sqrt(x))};
const inside=(lng,lat)=> userCenter? hav(lng,lat,userCenter.lng,userCenter.lat)<=RAD_M:false;
const circle=(lng,lat,r,steps=96)=>({type:"Feature",geometry:{type:"Polygon",coordinates:[Array.from({length:steps+1},(_,i)=>{const a=i/steps*2*Math.PI,p=off(lng,lat,Math.cos(a)*r,Math.sin(a)*r);return[p.lng,p.lat]})]}}); 
const drawRadius=()=>{if(!userCenter)return;const d=circle(userCenter.lng,userCenter.lat,RAD_M);if(!map.getSource(RADSRC)){map.addSource(RADSRC,{type:"geojson",data:d});map.addLayer({id:RADF,type:"fill",source:RADSRC,paint:{"fill-color":"#2b2b2b","fill-opacity":.02}});map.addLayer({id:RADL,type:"line",source:RADSRC,paint:{"line-color":"#2b2b2b","line-width":2,"line-opacity":0.08}})}else map.getSource(RADSRC).setData(d)};
/* BASEMAP (single declaration) */
const FALLBACK_STYLE={version:8,name:"OSM Raster",sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"¬© OpenStreetMap contributors"}},layers:[{id:"osm",type:"raster",source:"osm"}]};
async function initMap(){if(window.maplibregl&&typeof maplibregl.supported==="function"&&!maplibregl.supported())return note("WebGL disabled. Enable hardware acceleration.");
  note("loading map‚Ä¶");let styleObj=null;try{const r=await fetch("https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",{mode:"cors"});if(r.ok)styleObj=await r.json()}catch{};if(!styleObj)styleObj=FALLBACK_STYLE;
  map=new maplibregl.Map({container:"gl",style:styleObj,center:START,zoom:11,dragRotate:false,pitchWithRotate:false,maxPitch:0,renderWorldCopies:false,antialias:false,trackResize:true,fadeDuration:0});
  map.addControl(new maplibregl.NavigationControl({showCompass:false}),"bottom-right");
  map.on("error",e=>{console.error(e);note("map error (see console)")});
  map.on("load",async()=>{map.resize();clearNote();wire();init();tick();await tryRestoreFromDB()});
  map.on("move",()=>{if(anchor){refreshComment();refreshYou()}})}
/* you label */
const youPos=()=>anchor?[anchor.lng,anchor.lat+((geoH/2)+10)/E111]:null;
const showYou=()=>{if(!anchor)return;const p=youPos();if(!p)return;if(!youMarker){const el=document.createElement("div");el.textContent="you";el.style.cssText="font:600 11px/1 Inter,system-ui;color:#111;background:#fff;padding:2px 6px;border-radius:999px;border:1px solid #ddd;box-shadow:0 1px 2px rgba(0,0,0,.06);pointer-events:none;";youMarker=new maplibregl.Marker({element:el,anchor:"bottom"}).setLngLat(p).addTo(map)}else youMarker.setLngLat(p)};
const refreshYou=()=>{if(youMarker&&anchor){const p=youPos();p&&youMarker.setLngLat(p)}},hideYou=()=>{youMarker?.remove();youMarker=null},youAuto=()=>{if(!anchor)return hideYou();(commentText.trim()?hideYou:showYou)()};
/* placement preview */
let cleanup=()=>{};
const ghostAt=(lng,lat)=>{if(!userCenter){$("hint").textContent="Click ‚ÄúUse my location‚Äù first";sh("hint",true);return ghost(1)}if(!inside(lng,lat)){ghost(1);if(step===2){$("hint").textContent="place inside 1-mile radius";sh("hint",true)};return}
  const px=curPx();fit(px);const r=mpp(lng,lat),s=Math.pow(2,map.getZoom()-ZREF),w=baseW*r.x*s,h=baseH*r.y*s,coords=quad(lng,lat,w,h);
  const poly={type:"Feature",geometry:{type:"Polygon",coordinates:[[...coords,coords[0]]]}}; 
  if(!map.getSource(GBOX)){map.addSource(GBOX,{type:"geojson",data:poly});map.addLayer({id:GBOXF,type:"fill",source:GBOX,paint:{"fill-color":"#1e90ff","fill-opacity":.08}});map.addLayer({id:GBOXL,type:"line",source:GBOX,paint:{"line-color":"#1e90ff","line-width":2}})}else map.getSource(GBOX).setData(poly);
  if(imgURL&&(mode==="img"||mode==="gif")){if(!map.getSource(GIMG)){map.addSource(GIMG,{type:"image",url:imgURL,coordinates:coords});map.addLayer({id:GIMGL,type:"raster",source:GIMG,paint:{"raster-opacity":.35,"raster-fade-duration":0}})}else map.getSource(GIMG)?.setCoordinates?.(coords)}};
const ghost=b=>{if(!b)return;rm(GIMGL,1);rm(GIMG,0);rm(GBOXL,1);rm(GBOXF,1);rm(GBOX,0)};
const startPlace=()=>{try{cleanup()}catch{};$("hint").textContent=MOBI?"Pan map, then Place here":"go on map and place inside radius";sh("hint",true);
  if(!MOBI){const mv=e=>ghostAt(e.lngLat.lng,e.lngLat.lat),ck=e=>{const{lng,lat}=e.lngLat;if(!inside(lng,lat))return($("hint").textContent="place inside 1-mile radius",sh("hint",true));stop();anchor={lng,lat};fit(curPx());lockMeters();if(hasMedia())applyMedia();if(mediaReady)updStamp();updateComment();youAuto();showStep(3)},key=ev=>{if(ev.key==="Escape")stop()};
    map.getCanvas().classList.add("crosshair");map.on("mousemove",mv);map.once("click",ck);document.addEventListener("keydown",key);
    cleanup=()=>{map.getCanvas().classList.remove("crosshair");try{map.off("mousemove",mv)}catch{};try{document.removeEventListener("keydown",key)}catch{};ghost(1);sh("hint",false)}}
  else{const follow=()=>{const c=map.getCenter();ghostAt(c.lng,c.lat)};map.on("move",follow);follow();sh("placeHere",true);
    const placeNow=()=>{const c=map.getCenter();if(!inside(c.lng,c.lat))return alert("You can only post within 1 mile of your current location.");anchor={lng:c.lng,lat:c.lat};stop();fit(curPx());lockMeters();if(hasMedia())applyMedia();if(mediaReady)updStamp();updateComment();youAuto();showStep(3)};
    on($("placeHere"),"click",placeNow);
    cleanup=()=>{try{map.off("move",follow)}catch{};sh("placeHere",false);ghost(1);sh("hint",false)}}function stop(){try{cleanup()}catch{}}};
/* stamping */
const clearGIF=()=>{cancelAnimationFrame(gifRAF);gifRAF=0;gifCanvas=gifCtx=null};
const clearMedia=()=>{clearGIF();rm(LID,1);rm(SID,0);removeYT();mediaReady=0;sh("step3x",false)};
const applyMedia=()=>{clearMedia();if(!anchor)return;const c=quad(anchor.lng,anchor.lat,geoW,geoH);
  if(mode==="yt"){showYT();mediaReady=1;updYT();updateComment();sh("step3x",true);compactify();youAuto();maybeSaveOnce();return}
  if(mode==="vid"){map.addSource(SID,{type:"video",urls:[imgURL],coordinates:c});map.addLayer({id:LID,type:"raster",source:SID,paint:{"raster-opacity":1,"raster-fade-duration":0}});map.getSource(SID)?.play?.();mediaReady=1;updateComment();sh("step3x",true);compactify();youAuto();maybeSaveOnce();return}
  if(mode==="gif"&&gifCanvas){map.addSource(SID,{type:"canvas",canvas:gifCanvas,coordinates:c,animate:true});map.addLayer({id:LID,type:"raster",source:SID,paint:{"raster-opacity":1,"raster-fade-duration":0}});mediaReady=1;updateComment();sh("step3x",true);compactify();youAuto();maybeSaveOnce();return}
  map.addSource(SID,{type:"image",url:imgURL,coordinates:c});map.addLayer({id:LID,type:"raster",source:SID,paint:{"raster-opacity":1,"raster-fade-duration":0}});mediaReady=1;updateComment();sh("step3x",true);compactify();youAuto();maybeSaveOnce()};
const updStamp=()=>{const s=map.getSource(SID);s&&anchor&&s.setCoordinates?.(quad(anchor.lng,anchor.lat,geoW,geoH))};
/* YouTube overlay */
const showYT=()=>{removeYT();ytBox=document.createElement("div");ytBox.id="ytBox";const f=document.createElement("iframe");
  f.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";f.referrerPolicy="strict-origin-when-cross-origin";
  f.src=`https://www.youtube.com/embed/${ytID}?autoplay=1&mute=1&playsinline=1&controls=1`;ytBox.appendChild(f);document.body.appendChild(ytBox);map.on("move",updYT);window.addEventListener("resize",updYT)};
const updYT=()=>{if(!anchor||!ytBox)return;const tl=off(anchor.lng,anchor.lat,-geoW/2,+geoH/2),br=off(anchor.lng,anchor.lat,+geoW/2,-geoH/2);
  const p1=map.project([tl.lng,tl.lat]),p2=map.project([br.lng,br.lat]),s=ytBox.style;s.left=Math.min(p1.x,p2.x)+"px";s.top=Math.min(p1.y,p2.y)+"px";s.width=Math.abs(p2.x-p1.x)+"px";s.height=Math.abs(p2.y-p1.y)+"px"};
const removeYT=()=>{try{map.off("move",updYT)}catch{};window.removeEventListener("resize",updYT);ytBox?.parentNode?.removeChild(ytBox);ytBox=null};
/* comments (15-char cap) */
const stampPx=()=>{if(!anchor)return{h:0};const tl=off(anchor.lng,anchor.lat,-geoW/2,+geoH/2),br=off(anchor.lng,anchor.lat,+geoW/2,-geoH/2);
  const p1=map.project([tl.lng,tl.lat]),p2=map.project([br.lng,br.lat]);return{h:Math.abs(p2.y-p1.y)}};
const refreshComment=()=>{if(!domCmt||!anchor)return;const latUp=anchor.lat+((geoH/2)+6)/E111;domCmt.setLngLat([anchor.lng,latUp]);const{h}=stampPx();const px=Math.max(13,Math.min(64,h*0.12));domCmt.getElement().style.fontSize=px.toFixed(2)+"px"};
const updateComment=()=>{commentText=(commentText||"").slice(0,MAX_CMT);const t=commentText.trim();
  if(!t||!anchor){domCmt?.remove();domCmt=null;setLSComment("");youAuto();return}
  hideYou();
  if(!domCmt){const el=document.createElement("div");el.style.cssText=["font:700 12px/1.25 Inter, system-ui","color:#111","background:rgba(255,255,255,.98)","padding:4px 8px","border-radius:10px","border:1px solid rgba(0,0,0,.12)","box-shadow:0 2px 8px rgba(0,0,0,.25)","backdrop-filter:saturate(1.1) blur(2px)","white-space:pre","pointer-events:none","letter-spacing:.1px","-webkit-font-smoothing:antialiased","text-rendering:optimizeLegibility"].join(";");el.textContent=t;domCmt=new maplibregl.Marker({element:el,anchor:"bottom"}).setLngLat([anchor.lng,anchor.lat]).addTo(map)}else domCmt.getElement().textContent=t;
  refreshComment();setLSComment(t)};
/* persistence calls */
const clampComment=v=>((v||"").slice(0,MAX_CMT).trim()||null);
async function saveOrUpdate(fields){try{
  const fieldCmt = fields && fields.comment !== undefined ? clampComment(fields.comment) : clampComment(commentText);
  if(!savedId){
    if(!anchor||!hasMedia())return;
    const body={lng:anchor.lng,lat:anchor.lat,mediaType:mode,url:(mode==="yt")?null:(imgURL||null),ytId:(mode==="yt")?(ytID||null):null,
      comment: fieldCmt, natSize:(natW&&natH)?{w:natW,h:natH}:null, pxAtPlace:(typeof fields?.pxAtPlace==="number")?fields.pxAtPlace:curPx(), userCenter:userCenter||null, deviceId};
    const r=await fetchJSON(`${API}/api/posts`,{method:"POST",headers:{"Content-Type":"application/json","X-Device-Id":deviceId},body:JSON.stringify(body)});
    if(r&&r.id){savedId=r.id;localStorage.setItem(LS_ID,savedId)}
  }else{
    const patch={...fields}; if(patch.comment!==undefined) patch.comment = clampComment(patch.comment);
    const resp=await fetch(`${API}/api/posts/${savedId}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-Device-Id":deviceId},body:JSON.stringify(patch)});
    if(!resp.ok && resp.status===404){ savedId=""; localStorage.removeItem(LS_ID); }
  }
}catch(e){console.error("save/update failed",e)}}
async function maybeSaveSize(px){if(!anchor||!hasMedia())return;const now=Date.now();if(!savedId){await saveOrUpdate({pxAtPlace:Math.round(px)});lastPxSaved=Math.round(px);lastPxSavedAt=now;localStorage.setItem("lm_pxSaved",String(lastPxSaved));return}
  if(Math.abs(px-(lastPxSaved||0))>=SAVE_DELTA_PX&&(now-lastPxSavedAt)>=SAVE_INTERVAL_MS){await saveOrUpdate({pxAtPlace:Math.round(px)});lastPxSaved=Math.round(px);lastPxSavedAt=now;localStorage.setItem("lm_pxSaved",String(lastPxSaved))}}
async function maybeSaveOnce(){if(savedId||!anchor||!hasMedia())return;await saveOrUpdate({pxAtPlace:curPx(),comment:clampComment(commentText)})}
/* compact UI */
const setCompact=b=>{compact=!!b;$("ui").classList.toggle("compact",compact);sh("compact",compact);["topRow","step1","step2","step3","step3x","hint"].forEach(id=>sh(id,!compact&&(id!=="step3x"||step===3)));if(!compact)showStep(step)};
const finalizeUI=()=>["topRow","step1","step2","step3","step3x","hint","expandUI"].forEach(id=>$(id)?.parentNode?.removeChild($(id)));
const compactify=()=>{sh("doneBtn",true);setCompact(true);finalizeUI()};on($("expandUI"),"click",()=>setCompact(false));on($("doneBtn"),"click",()=>{setCompact(true);finalizeUI()});
/* growth tick (persists size) */
const grow=()=>{const px=curPx();$("curSize")&&($("curSize").textContent=px+"px");$("miniCur").textContent=px+"px";if(!anchor)return;fit(px);lockMeters();mediaReady&&(ytBox?updYT():updStamp());refreshComment();refreshYou();maybeSaveSize(px)};
const tick=()=>{if(timer)return;let last=performance.now();timer=setInterval(()=>{const n=performance.now();tAct=Math.min(GOAL,tAct+(n-last)*SPEED);last=n;grow()},1000)};
/* steps & init */
const setHint=()=>sh("hint",step===2&&!MOBI?($("hint").textContent="go on map and place inside radius",true):false);
let showStep=n=>{["step1","step2","step3"].forEach((id,i)=>sh(id,i===n-1));step=n;sh("placeHere",n===2&&MOBI);sh("placeTip",n===2&&!MOBI);if(n!==3)sh("step3x",false);setHint();if(n===3)sh("step3x",true)};
const setLoc=t=>{const e=$("locState");e&&(e.textContent=t)},init=()=>{showStep(1);$("doStep1").textContent="üìç Use my location";$("rateTag").textContent="rate: 1.35√ó";setLoc("allow location to show your 1-mile radius")};$("doStep1").onclick=()=>geoOnce();
/* geolocation */
navigator.permissions?.query?.({name:"geolocation"}).then(s=>{if(s.state==="denied"){const h=$("hint");if(h){h.textContent="Location is blocked. Allow it in your browser site settings.";sh("hint",true)}}}).catch(()=>{});
function geoOnce(){setLoc("Location: requesting‚Ä¶");if(!("geolocation"in navigator))return setLoc("Location: unsupported"),alert("Geolocation not supported.");
  navigator.geolocation.getCurrentPosition(p=>{const{longitude:lng,latitude:lat}=p.coords;userCenter={lng,lat};drawRadius();setLoc("location confirmed");map.easeTo({center:[lng,lat],zoom:14,duration:600});showStep(2);startPlace()},
    _=>{setLoc("Location: denied/unavailable");if(!window.isSecureContext&&location.hostname!=="localhost")alert("Use HTTPS or http://localhost ‚Äî browsers block geolocation on file://");else alert("Couldn‚Äôt get location. Check site permissions and try again.")},
    {enableHighAccuracy:true,timeout:30000,maximumAge:0})}
/* media loaders */
const startGIFLoop=()=>{if(!gifCanvas)return;const d=()=>{if(!gifCanvas)return;gifCtx.clearRect(0,0,gifCanvas.width,gifCanvas.height);gifCtx.drawImage(gifCanvas._img,0,0,gifCanvas.width,gifCanvas.height);map.triggerRepaint();gifRAF=requestAnimationFrame(d)};d()};
const setupGIF=src=>{imgURL=src;const im=new Image();im.crossOrigin="anonymous";im.onload=()=>{natW=im.naturalWidth||256;natH=im.naturalHeight||256;const cap=1024,s=Math.min(1,cap/Math.max(natW,natH));gifCanvas=document.createElement("canvas");gifCanvas.width=Math.max(1,Math.round(natW*s));gifCanvas.height=Math.max(1,Math.round(natH*s));gifCtx=gifCanvas.getContext("2d");gifCanvas._img=im;if(!anchor){const h=$("hint");if(h){h.textContent="Place first";sh("hint",true)}return}startGIFLoop();applyMedia()};im.onerror=()=>alert("Couldn't load that GIF.");im.src=src};
/* upload to server, then display */
const uploadFile=async(f)=>{const form=new FormData();form.append('file',f,f.name||'upload');const r=await fetch(`${API}/api/upload`,{method:'POST',body:form});if(!r.ok)throw new Error('upload failed');return r.json()};
const loadFile=async(f)=>{if(!anchor)return(($("hint")||{}).textContent="Place first",sh("hint",true));try{
  const {url,mime}=await uploadFile(f);
  if((mime||'').startsWith('video/')){mode='vid';imgURL=url;const v=document.createElement('video');v.src=url;v.onloadedmetadata=()=>{natW=v.videoWidth||16;natH=v.videoHeight||9;applyMedia()};v.onerror=()=>{natW=16;natH=9;applyMedia()};return}
  if(mime==='image/gif'){mode='gif';setupGIF(url);return}
  mode='img';imgURL=url;const im=new Image();im.crossOrigin="anonymous";im.onload=()=>{natW=im.naturalWidth||256;natH=im.naturalHeight||256;applyMedia()};im.onerror=()=>alert("Couldn't load that image.");im.src=url
}catch(e){console.error(e);alert('Upload failed. Try again.')}};
/* pasted/typed URL path */
const loadURL=u=>{if(u.startsWith("blob:"))return alert("That URL is temporary. Please upload the file or use an http(s) link.");if(!safeURL(u))return alert("URL not allowed. Use /uploads, http(s) or data:.");
  const d=detect(u);mode=d.t;
  if(mode==="yt"){ytID=d.id;natW=16;natH=9;return anchor?applyMedia():(($("hint")||{}).textContent="Place first",sh("hint",true))}
  if(mode==="vid"){imgURL=d.url;if(!anchor)return(($("hint")||{}).textContent="Place first",sh("hint",true));const v=document.createElement("video");v.muted=true;v.playsInline=true;v.src=imgURL;v.onloadedmetadata=()=>{natW=v.videoWidth||16;natH=v.videoHeight||9;applyMedia()};v.onerror=()=>{natW=16;natH=9;applyMedia()};return}
  if(mode==="gif")return setupGIF(d.url);
  imgURL=d.url;const im=new Image();im.crossOrigin="anonymous";im.onload=()=>{natW=im.naturalWidth||256;natH=im.naturalHeight||256;anchor?applyMedia():(($("hint")||{}).textContent="Place first",sh("hint",true))};im.onerror=()=>alert("Couldn't load that image.");im.src=imgURL};
/* history + restore */
const fetchHistory=async(deviceId,limit=10)=>{try{const q=deviceId?`?deviceId=${encodeURIComponent(deviceId)}&limit=${limit}`:`?limit=${limit}`;return await fetchJSON(`${API}/api/posts/history${q}`)}catch{return[]}};
async function tryRestoreFromDB(){
  let id=localStorage.getItem(LS_ID); let p=null;
  try{ if(id){ try{ p=await fetchJSON(`${API}/api/posts/${id}`) }catch{} }
       if(!p){ const did=localStorage.getItem(LS_DEVICE); if(did){ try{ p=await fetchJSON(`${API}/api/posts/latest?deviceId=${encodeURIComponent(did)}`) }catch{} } }
       if(!p){ try{ p=await fetchJSON(`${API}/api/posts/latest`) }catch{} }
       if(!isValidMedia(p)){ const did=localStorage.getItem(LS_DEVICE)||null; const hist=await fetchHistory(did,10); p=hist.find(isValidMedia)||null; }
  }catch(e){ console.error("restore error",e) }

  if(!p || !Array.isArray(p.coordinates)){
    savedId=""; localStorage.removeItem(LS_ID);
    setLSComment(""); commentText=""; updateComment();
    return;
  }

  savedId=p.id; localStorage.setItem(LS_ID,savedId);
  anchor={lng:p.coordinates[0],lat:p.coordinates[1]};
  userCenter=p.userCenter||null; if(userCenter) drawRadius();

  mode=p.mediaType||"img"; if(mode==="yt") ytID=p.ytId||""; else imgURL=p.url||"";
  if(p.natSize&&p.natSize.w&&p.natSize.h){ natW=p.natSize.w; natH=p.natSize.h }

  const px=p.pxAtPlace||MINPX; tAct=tFromPx(px);
  lastPxSaved=Math.round(px); localStorage.setItem("lm_pxSaved",String(lastPxSaved));
  fit(px); lockMeters(); applyMedia();

  commentText=(p.comment ?? ""); commentText=commentText.slice(0,MAX_CMT);
  setLSComment(commentText); updateComment(); youAuto();
  const mini=$("miniCmt"); if(mini) mini.value=commentText;

  grow(); map.easeTo({center:[anchor.lng,anchor.lat],zoom:14,duration:400}); showStep(3); sh("step3x",true); compactify();
}
/* wiring & start */
function wire(){
  const deb=(f,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),ms)}};
  on($("picUpload"),"click",()=>$("picFile")?.click());
  on($("picFile"),"change",e=>{const f=e.target.files?.[0];f&&loadFile(f);e.target.value=""});
  const pin=$("picInput"),tryURL=deb(()=>{const v=pin.value.trim();v&&loadURL(v)},250);
  on(pin,"input",tryURL); on(pin,"change",()=>{const v=pin.value.trim();v&&loadURL(v)}); on(pin,"paste",tryURL);

  const saveCmt=deb(async()=>{ setLSComment(commentText); await saveOrUpdate({comment:clampComment(commentText)}) },400);
  on($("miniCmt"),"input",async()=>{ commentText=$("miniCmt").value.slice(0,MAX_CMT); updateComment(); await saveCmt() });

  on($("changeImg"),"click",()=>$("picFile")?.click());

  const flushOnHide=async()=>{ try{
      setLSComment(commentText);
      if (!savedId) return;
      const resp=await fetch(`${API}/api/posts/${savedId}`,{
        method:"PATCH", keepalive:true,
        headers:{'Content-Type':'application/json','X-Device-Id':deviceId},
        body:JSON.stringify({comment:clampComment(commentText), pxAtPlace:curPx()})
      });
      if(!resp.ok && resp.status===404){ savedId=""; localStorage.removeItem(LS_ID); }
      else { localStorage.setItem("lm_pxSaved",String(curPx())) }
    }catch{} };
  document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==='hidden') flushOnHide() });
  window.addEventListener("pagehide",flushOnHide);
}
initMap();
</script>
</body></html>
